<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitación Baby Shower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // Importa solo lo que necesitas para la inicialización
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // TU CONFIGURACIÓN DE FIREBASE (¡Con tus datos, tal como me los diste!)
        const firebaseConfig = {
            apiKey: "AIzaSyDa8xUmziIYohy8TymBrhRT4nVRcUMkvdE",
            authDomain: "babyshowerela.firebaseapp.com",
            projectId: "babyshowerela",
            storageBucket: "babyshowerela.firebasestorage.app",
            messagingSenderId: "848219577782",
            appId: "1:848219577782:web:41bcb427e6f11c7ebeb517"
        };

        // Inicializa Firebase y hazlo global
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        window.currentUserId = null; // Se actualizará al autenticarse
        window.appId = firebaseConfig.appId; // También hacemos appId global si es necesario

        // Autenticación Anónima
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${window.currentUserId}`;
            } else {
                try {
                    // Aquí no usamos __initial_auth_token ni __app_id porque estamos en Netlify
                    await signInAnonymously(window.auth);
                } catch (error) {
                    console.error("Error during Firebase authentication:", error);
                    document.getElementById('userIdDisplay').textContent = `Error de autenticación: ${error.message}`;
                }
            }
        });
    </script>
    <style>
        /* ... Tu CSS ... */
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="card-container">
            <div class="card" id="card-6">
                <input type="text" id="guestNameInput" placeholder="Tu nombre" class="...">
                <button id="confirmRsvpBtn" class="..."></button>
                <p id="rsvpMessage" class="..."></p>
                <ul id="confirmedGuestsList" class="..."></ul>
            </div>
        </div>

        <div class="navigation-buttons">
            <button id="prevBtn" class="nav-button" disabled>Anterior</button>
            <button id="nextBtn" class="nav-button">Siguiente</button>
        </div>
        <div id="userIdDisplay" class="text-xs text-gray-400 mt-2"></div>
    </div>

    <script type="module">
        // Importa solo lo que necesitas para la lógica de la app
        // Asegúrate de que estas importaciones están en un script 'type="module"'
        import { collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Ahora puedes acceder a window.db, window.auth, window.currentUserId
        // y window.appId (si lo hiciste global arriba)
        
        const cards = document.querySelectorAll('.card');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const dotsContainer = document.getElementById('dotsContainer');
        const addToCalendarBtn = document.getElementById('addToCalendarBtn');
        const musicToggleBtn = document.getElementById('musicToggleBtn');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const guestNameInput = document.getElementById('guestNameInput');
        const confirmRsvpBtn = document.getElementById('confirmRsvpBtn');
        const rsvpMessage = document.getElementById('rsvpMessage');
        const confirmedGuestsList = document.getElementById('confirmedGuestsList');

        let currentCardIndex = 0;
        let isPlaying = false;
        let hasInteractedForMusic = false;

        // ... el resto de tu lógica de JavaScript para las tarjetas y botones ...

        // --- Funcionalidad de Confirmación de Asistencia (RSVP) ---
        confirmRsvpBtn.addEventListener('click', async () => {
            const guestName = guestNameInput.value.trim();
            if (!guestName) {
                rsvpMessage.textContent = "Por favor, ingresa tu nombre.";
                rsvpMessage.style.color = "red";
                return;
            }

            // Asegúrate de que db esté disponible
            if (!window.db) {
                rsvpMessage.textContent = "Error: Firebase no está inicializado. No se puede confirmar asistencia.";
                rsvpMessage.style.color = "red";
                console.error("Firestore is not initialized.");
                return;
            }

            try {
                // Usamos window.appId que hicimos global arriba
                const rsvpsCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/rsvps`);
                await addDoc(rsvpsCollectionRef, {
                    name: guestName,
                    timestamp: new Date(),
                    userId: window.currentUserId // Save user ID for tracking
                });
                rsvpMessage.textContent = `¡Gracias, ${guestName}! Tu asistencia ha sido confirmada.`;
                rsvpMessage.style.color = "green";
                guestNameInput.value = ''; // Clear the input field
            } catch (e) {
                console.error("Error adding document: ", e);
                rsvpMessage.textContent = "Hubo un error al confirmar tu asistencia. Intenta de nuevo.";
                rsvpMessage.style.color = "red";
            }
        });

        // Listen for real-time updates on confirmed guests
        if (window.db) {
            const rsvpsCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/rsvps`);
            const q = query(rsvpsCollectionRef, orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                confirmedGuestsList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const guest = doc.data();
                    const listItem = document.createElement('li');
                    listItem.textContent = guest.name;
                    confirmedGuestsList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error listening to RSVPs:", error);
            });
        }

        // Inicializar la primera tarjeta y los botones/puntos al cargar la página
        showCard(currentCardIndex);
    </script>
</body>
</html>